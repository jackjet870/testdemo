!function(){var e={options:{urls:{roles:"/Membership/V1/Users/api/Roles",usersInRoles:"/Membership/V1/Users/api/UsersInRoles",self:"/Membership/V1/Users/Page/RoleHeaderDetail",decrypt:"/Membership/V1/Users/api/Crypto/Decrypt"},messages:App.str.text("Messages"),strings:App.str.text("StringContents")},values:{role_id:{}},events:{defaults:{initialize:{},getParameters:{},setErrorFocus:{},initializeControl:{},initializeControlEvent:{},loadMasterData:{},loadData:{},loadDialogs:{},createValidator:{},validateAll:{},serviceValidationFail:{},confirm:{}}},operations:{defaults:{save:{},remove:{}}},header:{options:{urls:{},validations:{},bindOption:{}},events:{defaults:{initialize:{},bind:{},change:{}}}},detail:{options:{urls:{users:"/Membership/V1/Users/api/Users"},validations:{},bindOption:{}},values:{},events:{defaults:{initialize:{},bind:{},change:{},validateList:{},validateListCount:{}}},operations:{defaults:{select:{},addNewItem:{},deleteItem:{}}}},dialogs:{searchModal:{options:{urls:{searchDialog:"/Membership/V1/Users/page/SearchDialog"}}}}};e.events.defaults.initialize=function(){e.notify=App.ui.page.notify(e.events.defaults.setErrorFocus),App.ui.loading.show(),e.events.defaults.getParameters(),e.events.defaults.initializeControl(),e.events.defaults.initializeControlEvent(),e.header.events.defaults.initialize(),e.detail.events.defaults.initialize(),e.events.defaults.decryptParameters().then(function(){return e.events.defaults.loadMasterData()}).then(function(){return e.events.defaults.loadData()}).then(function(){return e.events.defaults.loadDialogs()}).then(function(e){}).fail(function(a){App.ui.page.normalizeError(a).forEach(function(a){e.notify.alert.message(a.message).show()}),$("#save").hide(),$("#remove").hide()}).always(function(e){$(":input:visible:not(:disabled):first").focus(),App.ui.loading.close()})},e.events.defaults.getParameters=function(){var a=App.uri.splitQuery(location.search);App.isUndefOrNull(a.role_id)?(e.values.role_id="",$("#remove").hide()):e.values.role_id=a.role_id},e.events.defaults.initializeControl=function(){var a=e.options.strings.RoleHeaderDetail;$(".page-title").text(a),document.title=a,App.isUndefOrNull(e.values.role_id)&&$("#remove").hide()},e.events.defaults.setErrorFocus=function(a){$(a).closest(".datatable").length?e.detail.dataTable.dataTable("setFocus",a):$(a).focus()},e.events.defaults.initializeControlEvent=function(){App.ui.page.applyCollapsePanel(),e.on($("#save"),"click",e.operations.defaults.save),e.on($("#remove"),"click",e.operations.defaults.remove)},e.events.defaults.decryptParameters=function(){var a=[e.values.role_id];return $.ajax(App.ajax.webapi.post(e.options.urls.decrypt,a)).then(function(a){e.values.role_id=a[0]})},e.events.defaults.loadMasterData=function(){return App.async.success()},e.events.defaults.loadData=function(){if(App.isUndefOrNull(e.values.role_id))return e.header.events.defaults.bind({},!0),e.detail.events.defaults.bind([],!0),App.async.success();var a={url:e.options.urls.roles,filter:"RoleId eq "+e.values.role_id,skip:0,top:1,count:!0};return App.async.all({header:$.ajax(App.ajax.webapi.get(App.data.toODataFormat(a))),detail:$.ajax(App.ajax.webapi.get(e.options.urls.usersInRoles,{roleId:e.values.role_id}))}).then(function(a){var t=a.successes.header,i=a.successes.detail;return t?(e.header.events.defaults.bind(t.Items[0]||{}),e.detail.events.defaults.bind(i||[]),void $("#remove").show()):(e.header.events.defaults.bind({},!0),e.detail.events.defaults.bind([],!0),e.notify.alert.message(e.options.messages.CannotDataRetrieved+e.options.messages.DoNewCreationMode).show(),App.async.success())},function(a){return App.ui.page.normalizeError(a).forEach(function(a){e.notify.alert.message(a.message).show()}),e.header.events.defaults.bind({},!0),e.detail.events.defaults.bind([],!0),App.async.success()})},e.events.defaults.loadDialogs=function(){return $.get(e.dialogs.searchModal.options.urls.searchDialog).then(function(a){$("#dialog-container").append(a),e.dialogs.searchModal=window.searchModal,e.dialogs.searchModal.events.defaults.initialize(),e.dialogs.searchModal.events.complete=e.detail.events.setUser})},e.events.defaults.serviceValidationFail=function(a){e.notify.alert.message(a.message).show()},e.events.defaults.validateAll=function(){var a=[];return a.push(e.header.validator.validate()),a.push(e.detail.events.defaults.validateList()),App.async.all(a)},e.events.createValidator=function(a,t){return e.events.defaults.validationSuccess=e.events.defaults.validationSuccess||App.ui.page.validationSuccess(e.notify),e.events.defaults.validationFail=e.events.defaults.validationFail||App.ui.page.validationFail(e.notify),e.events.defaults.validationAlways=e.events.defaults.validationAlways||App.ui.page.validationAlways(e.notify),App.validation(a,t||{success:e.events.defaults.validationSuccess,fail:e.events.defaults.validationFail,always:e.events.defaults.validationAlways})},e.operations.defaults.save=function(){App.ui.loading.show(),e.notify.alert.clear(),e.notify.info.clear(),e.events.defaults.validateAll().then(function(){var a=e.header.element.attr("data-key"),t=(e.header.data.entry(a),{});return""==e.values.role_id&&(t="new"),$.ajax(App.ajax.webapi.post(e.options.urls.usersInRoles,{changeSet:e.detail.data.getChangeSet(),mode:t,RoleID:e.values.role_id,RoleName:$.findP("RoleName").val(),Description:$.findP("Description").val()})).then(function(a){if("00000000-0000-0000-0000-000000000000"!=a.RoleID){e.notify.info.message(e.options.messages.SaveCompleted).show();var t=App.uri.setQuery(e.options.urls.self,{role_id:a.RoleID});window.open(t,"_self")}else e.notify.alert.clear(),e.notify.info.clear(),e.events.defaults.loadData(),e.notify.info.message(e.options.messages.SaveCompleted).show()}).fail(function(a){var t=App.ui.page.normalizeError(a),i=t[0];if(i){if(i.errorType===App.settings.base.errorTypes.inputError)return;if(i.errorType===App.settings.base.errorTypes.conflictError)return void e.notify.alert.message(e.options.messages.UpdateConfilict).show()}t.forEach(function(a){e.notify.alert.message(a.message).show()})})}).always(function(){setTimeout(function(){e.header.element.find(":input:first").focus()},100),App.ui.loading.close()})},e.operations.defaults.remove=function(){e.notify.alert.clear(),e.notify.info.clear(),App.ui.page.confirm({text:e.options.messages.ConfirmDelete}).then(function(){App.ui.loading.show();var a=App.uri.setQuery(e.options.urls.usersInRoles,{roleId:e.values.role_id});$.ajax(App.ajax.webapi["delete"](a)).then(function(a){e.notify.alert.clear(),e.notify.info.clear(),e.notify.info.message(e.options.RemoveCompleted).show(),setTimeout(function(){var e=App.uri.parse(location.href);e.query&&delete e.query,location.href=App.uri.toUriString(e)},100)}).fail(function(a){var t=App.ui.page.normalizeError(a),i=t[0];if(i){if(i.errorType===App.settings.base.errorTypes.inputError)return;if(i.errorType===App.settings.base.errorTypes.conflictError)return void e.notify.alert.message(e.options.messages.UpdateConfilict).show()}t.forEach(function(a){e.notify.alert.message(a.message).show()})}).always(function(){setTimeout(function(){$(":input:visible:not(:disabled):first").focus()},100),App.ui.loading.close()})})},e.header.options.validations={RoleName:{rules:{required:!0,maxlength:50},options:{name:e.options.strings.RoleName},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}}},e.header.events.defaults.initialize=function(){var a=$(".header");e.header.validator=a.validation(e.events.createValidator(e.header.options.validations)),e.on(a,"change",":input",e.header.events.defaults.change),e.header.element=a},e.header.events.defaults.bind=function(a,t){var i=(e.header.element,App.ui.page.dataSet());e.header.data=i,(t?i.add:i.attach).bind(i)(a),e.header.element.form().bind(a)},e.header.events.defaults.change=function(a){var t=e.header.element,i=$(a.target),s=t.attr("data-key"),n=i.attr("data-prop"),l=e.header.data.entry(s),o=t.form().data();t.validation().validate({targets:i}).then(function(){l[n]=o[n],e.header.data.update(l)})},e.detail.options.validations={UserName:{rules:{required:!0,maxlength:50},options:{name:e.options.strings.UserName},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}}},e.detail.events.defaults.initialize=function(){var a=$(".detail"),t=a.find(".datatable"),i=t.dataTable({height:300,sortable:!0,fixedColumn:!1,innerWidth:1e3,onselect:e.detail.operations.defaults.select,onchange:e.detail.events.defaults.change,resize:!1});e.detail.validator=a.validation(e.events.createValidator(e.detail.options.validations)),e.detail.element=a,e.detail.dataTable=i;var s=App.ui.page.dataSet();e.detail.data=s,e.on(a,"click","#add-item",e.detail.operations.defaults.addNewItem),e.on(a,"click","#del-item",e.detail.operations.defaults.deleteItem),e.on(a,"click",".show-search-dialog",e.detail.operations.showsearchdialog)},e.detail.operations.showsearchdialog=function(){var a=e.dialogs.searchModal.element;a.modal("show")},e.detail.events.defaults.bind=function(a,t){var i,s,n,l=(e.detail.element,App.ui.page.dataSet());for(totalCount=App.isNum(a.length)?a.length:"-",count=a.length||0,e.detail.data=l,e.detail.dataTable.dataTable("clear"),i=0,s=a.length;s>i;i++)n=a[i],(t?l.add:l.attach).bind(l)(n),e.detail.events.defaults.addRow(n,0===i);$(".data-count").text(count),$(".data-count-total").text(totalCount),e.detail.events.defaults.validateList(!0)},e.detail.events.defaults.change=function(a,t){var i=$(a.target),s=t.element.attr("data-key"),n=i.attr("data-prop"),l=e.detail.data.entry(s);e.detail.validator.validate({targets:i,state:{tbody:t,isGridValidation:!0}}).then(function(){l[n]=t.element.form().data()[n],e.detail.data.update(l)})},e.detail.events.defaults.validateList=function(a){var t=[];return e.detail.dataTable.dataTable("each",function(i,s){i.element.hasClass("item-tmpl")||t.push(e.detail.validator.validate({targets:i.element.find(":input"),state:{suppressMessage:a,tbody:i.element,isGridValidation:!0}}))}),App.async.all(t)},e.detail.events.calculate=function(a,t){var i,s;e.detail.values.suppressCalculate||(i=e.detail.data.findAll(function(e,a){return a.state!==App.ui.page.dataSet.status.Deleted}),s=i.reduce(function(e,a){return e},0))},e.detail.events.defaults.addRow=function(a,t){e.detail.dataTable.length;e.detail.dataTable.dataTable("addRow",function(t){t.form(e.detail.options.bindOption).bind(a),a.UserId||t.find(".show-search-dialog").css("display","");var i=t.findP("UserName");return i.prop("data-id",a.__id),t.findP("UserName").complete({textLength:50,ajax:function(a){var t={url:e.detail.options.urls.users,filter:"contains(UserName, '"+encodeURIComponent(a)+"') eq true",skip:0,top:1,count:!0};return $.ajax(App.ajax.webapi.get(App.data.toODataFormat(t),null,{async:!1}))},success:function(a){if(0==a.Count)return e.notify.alert.remove(i),e.notify.alert.message(e.options.messages.NotEixistsUser,i).show();e.notify.alert.remove(i);var s=a.Items[0];t.findP("RoleId").val(e.values.role_id),t.findP("UserId").val(s.UserId),t.findP("Email").text(s.Email);var n=s.UnitName?s.UnitName:"";t.findP("UnitName").text(n)},error:function(a){return e.notify.alert.remove(i),e.notify.alert.message(e.options.messages.NotEixistsUser,i).show()}}),t},t)},e.detail.operations.defaults.addNewItem=function(){var a={RoleId:e.values.role_id};e.detail.data.add(a),e.detail.events.defaults.addRow(a,!0)},e.detail.operations.defaults.deleteItem=function(a){var t;return e.detail.dataTable.dataTable("lastSelectedRow",function(e){t=e}),t&&t.element?void App.ui.page.confirm({text:e.options.messages.ConfirmDeleteDetail}).then(function(){t.element.find(":input").each(function(a,t){e.notify.alert.remove(t)});var a,i=$(t.element).index(),s=0,n=0;e.detail.dataTable.dataTable("enableRowCount",function(e){n=e+1}),s=n>i?i:i-2,a=$(".datatable tbody:eq("+s+")"),e.detail.dataTable.dataTable("deleteRow",t.element,function(t){var i=t.attr("data-key");if(!App.isUndefOrNull(i)){var s=e.detail.data.entry(i);e.detail.data.remove(s),a.click()}})}):void e.notify.info.message(e.options.messages.RemoveNotSletcted).show()},e.detail.operations.defaults.select=function(a,t){e.detail.dataTable.dataTable("lastSelectedRow",function(e){e&&e.element&&e.element.removeClass("selected")}),t&&t.element&&t.element.addClass("selected")},e.detail.events.setUser=function(a){var t=e.detail.element,i=t.find(".datatable .new.selected").closest("tbody");if(i.length){i.findP("RoleId").val(e.values.role_id).change(),i.findP("UserId").val(a.UserId).change(),i.findP("UserName").val(a.UserName).change(),i.findP("Email").text(a.Email).change();var s=a.UnitName?a.UnitName:"";i.findP("UnitName").text(s).change()}},$(document).ready(function(){e.events.defaults.initialize()}),App.ui.page.extend(e)}();