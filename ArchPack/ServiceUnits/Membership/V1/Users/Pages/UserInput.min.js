!function(){"use strict";var e={options:{urls:{data:"/Membership/V1/Users/api/Users",save:"/Membership/V1/Users/api/Users/Post",units:"/Membership/V1/Users/api/Units",decrypt:"/Membership/V1/Users/api/Crypto/Decrypt"},messages:App.str.text("Messages"),strings:App.str.text("StringContents")},values:{isNew:!0},events:{defaults:{initialize:{},getParameters:{},initializeControl:{},initializeControlEvent:{},loadMasterData:{},loadData:{},loadDialogs:{},createValidator:{},validateAll:{},serviceValidationFail:{}}},operations:{defaults:{save:{},remove:{}}},section:{options:{urls:{units:"/Account/_/_/api/Units"},validations:{}},events:{defaults:{initialize:{},loadMasterData:{},loadData:{},bind:{},change:{}}},dialogs:{}}};e.events.defaults.initialize=function(){e.notify=App.ui.page.notify(),App.ui.loading.show(),e.events.defaults.getParameters(),e.events.defaults.initializeControl(),e.events.defaults.initializeControlEvent(),e.section.events.defaults.initialize(),e.events.defaults.decryptParameters().then(function(){return e.events.defaults.loadMasterData()}).then(function(){return e.events.defaults.loadData()}).then(function(){return e.events.defaults.loadDialogs()}).then(function(e){}).fail(function(t){App.ui.page.normalizeError(t).forEach(function(t){e.notify.alert.message(t.message).show()}),$("#save").hide(),$("#remove").hide()}).always(function(e){$(":input:visible:not(:disabled):first").focus(),App.ui.loading.close()})},e.events.defaults.getParameters=function(){var t=App.uri.splitQuery(location.search);e.values.user_id=t.user_id,App.isUndefOrNull(e.values.user_id)?$.findP("UserName").prop("disabled",!1):$.findP("UserName").prop("disabled",!0)},e.events.defaults.initializeControl=function(){var t=e.options.strings.UserInput;$(".page-title").text(t),document.title=t},e.events.defaults.initializeControlEvent=function(){App.ui.page.applyCollapsePanel(),e.on($("#save"),"click",e.operations.defaults.save),e.on($("#remove"),"click",e.operations.defaults.remove)},e.events.defaults.decryptParameters=function(){var t=[e.values.user_id];return $.ajax(App.ajax.webapi.post(e.options.urls.decrypt,t)).then(function(t){e.values.user_id=t[0]})},e.events.defaults.loadMasterData=function(){return App.async.all($.ajax(App.ajax.webapi.get(e.options.urls.units)).then(function(t){e.events.setUnit(t)}))},e.events.setUnit=function(e){var t=$.findP("UnitId");t.children().remove(),App.ui.util.appendOptions({target:t,data:e,useEmpty:!0,reviver:function(e){return{value:e.UnitId,display:App.str.format("{UnitName}",e)}}})},e.events.defaults.loadData=function(){if($("#remove").hide(),App.isUndefOrNull(e.values.user_id))return e.section.events.defaults.bind({},!0),App.async.success();var t={url:e.options.urls.data,filter:"UserId eq "+e.values.user_id,skip:0,top:1,count:!0};return App.async.all({data:$.ajax(App.ajax.webapi.get(App.data.toODataFormat(t)))}).then(function(t){var s=t.successes.data;return s.Items.length?(e.section.events.defaults.bind((s.Items||s)[0]),void $("#remove").show()):(e.notify.alert.message(e.options.messages.NotEixistsUser).show(),e.section.events.defaults.bind({},!0),App.async.success())},function(t){return App.ui.page.normalizeError(t).forEach(function(t){e.notify.alert.message(t.message).show()}),e.section.events.defaults.bind({},!0),App.async.success()})},e.events.defaults.loadDialogs=function(){return App.async.all({}).then(function(e){})},e.events.defaults.createValidator=function(t,s){return e.events.defaults.validationSuccess=e.events.defaults.validationSuccess||App.ui.page.validationSuccess(e.notify),e.events.defaults.validationFail=e.events.defaults.validationFail||App.ui.page.validationFail(e.notify),e.events.defaults.validationAlways=e.events.defaults.validationAlways||App.ui.page.validationAlways(e.notify),App.validation(t,s||{success:e.events.defaults.validationSuccess,fail:e.events.defaults.validationFail,always:e.events.defaults.validationAlways})},e.events.defaults.validateAll=function(){return e.section.validator.validate()},e.operations.defaults.save=function(){App.ui.loading.show(),e.notify.alert.clear(),e.notify.info.clear(),e.events.defaults.validateAll().then(function(){var t=e.section.data.getChangeSet();return 0===t.created.length&&0===t.updated.length&&0===t.deleted.length?App.async.success():$.ajax(App.ajax.webapi.post(e.options.urls.save,t)).then(function(t){e.notify.alert.clear(),e.notify.info.clear(),e.values.user_id=(t.Users[0]||{}).UserId,$("#remove").show(),$.findP("UserName").prop("disabled",!0),e.events.defaults.loadData(),e.notify.info.message(e.options.messages.SaveCompleted).show()},function(t){var s=App.ui.page.normalizeError(t),a=s[0];if(a){if(a.errorType===App.settings.base.errorTypes.inputError)return void e.events.defautls.serviceValidationFail(result);if(a.errorType===App.settings.base.errorTypes.conflictError)return void e.notify.alert.message(e.options.messages.UpdateConfilict).show()}e.notify.alert.message(e.options.messages.SaveFailed).show()})}).always(function(){setTimeout(function(){$(":input:visible:not(:disabled):first").focus()},100),App.ui.loading.close()})},e.operations.defaults.remove=function(){App.ui.page.confirm({text:e.options.messages.ConfirmDelete}).then(function(){var t=e.section.element,s=t.attr("data-key");e.section.data.entry(s);return App.ui.loading.show(),e.notify.alert.clear(),e.notify.info.clear(),$.ajax(App.ajax.webapi["delete"](e.options.urls.data+"?UserId="+e.values.user_id)).then(function(t){e.notify.info.message(e.options.messages.RemoveCompleted).show(),setTimeout(function(){var e=App.uri.parse(location.href);e.query&&delete e.query.user_id,location.href=App.uri.toUriString(e)},100)},function(t){var s=App.ui.page.normalizeError(t),a=s[0];return a&&a.errorType===App.settings.base.errorTypes.conflictError?void e.notify.alert.message(e.options.messages.UpdateConfilict).show():void s.forEach(function(t){e.notify.alert.message(t.message).show()})}).always(function(){setTimeout(function(){$(":input:visible:not(:disabled):first").focus()},100),App.ui.loading.close()})})},e.events.defaults.serviceValidationFail=function(t){e.notify.alert.message(t.message).show(),t.errors.forEach(function(t){var s,a=e[t.objectId];a&&(s=a.element.findP(t.propertyId),e.events.defaults.validationFail([{message:t.message,element:s}]))})},e.section.options.validations={UserName:{rules:{required:!0,maxlength:50},options:{name:e.options.strings.UserName},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}},Password:{rules:{required:!0,minlength:6},options:{name:e.options.strings.Password},messages:{required:e.options.messages.Required,minlength:e.options.messages.MinLength}},Email:{rules:{required:!0,maxlength:100},options:{name:e.options.strings.Mail},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}},LastName:{rules:{required:!0,maxlength:50},options:{name:e.options.strings.LastName},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}},FirstName:{rules:{required:!0,maxlength:50},options:{name:e.options.strings.FirstName},messages:{required:e.options.messages.Required,maxlength:e.options.messages.MaxLength}}},e.section.options.bindOption={appliers:{},converters:{}},e.section.events.defaults.initialize=function(){var t=$(".section");e.section.validator=t.validation(e.events.defaults.createValidator(e.section.options.validations)),e.section.element=t,App.ui.page.applyInput(t),e.on(t,"change",":input",e.section.events.defaults.change),t.show()},e.section.events.defaults.bind=function(t,s){var a=e.section.element,i=App.ui.page.dataSet();e.section.data=i,(s?i.add:i.attach).bind(i)(t),a.form(e.section.options.bindOption).bind(t)},e.section.events.defaults.change=function(t){var s=e.section.element,a=$(t.target),i=s.attr("data-key"),n=a.attr("data-prop"),o=e.section.data.entry(i),r=s.form(e.section.options.bindOption).data();s.validation().validate({targets:a}).then(function(){o[n]=r[n],e.section.data.update(o)})},$(document).ready(function(){e.events.defaults.initialize()}),App.ui.page.extend(e)}();